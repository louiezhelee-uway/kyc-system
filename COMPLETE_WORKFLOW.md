# 🎯 完整工作流指南 - 从订单到报告

> **场景：** 你在闲鱼获取一个订单，需要为买家生成 KYC 验证链接。验证完成后，获取报告发给买家。自动发货将通过淘宝在 3-4 天后实现。

---

## 📊 完整流程图

```
┌─────────────────────────────────────────────────────────────┐
│                     闲鱼获取订单信息                          │
│                                                               │
│  用户号: alipay_user_12345                                   │
│  订单号: fy_order_20251208_001                               │
│  买家名: 小王                                                │
│  电话: 13800138000                                           │
│  邮箱: buyer@example.com                                     │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│      📝 第 1 步：登录管理后台                                 │
│      https://kyc.317073.xyz/admin-manual/                   │
│      密钥: [输入你的密钥]                                    │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│      ✏️  第 2 步：填写订单信息                                │
│      用户号: alipay_user_12345                               │
│      订单号: fy_order_20251208_001                           │
│      买家名: 小王                                            │
│      电话: 13800138000                                       │
│      邮箱: buyer@example.com                                 │
│      [点击 生成链接]                                         │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│      🎉 第 3 步：获得验证链接                                 │
│      https://kyc.317073.xyz/verify/token_abc123xyz          │
│      [复制链接]                                              │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│      💬 第 4 步：发送链接给买家                                │
│      通过闲鱼聊天、微信、邮件等方式发送验证链接              │
│                                                               │
│      "亲，请点击这个链接完成身份验证:"                       │
│      "https://kyc.317073.xyz/verify/token_abc123xyz"        │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│      🔍 第 5 步：买家完成验证                                 │
│      买家点击链接 → 进入验证页面                             │
│      选择验证方式（自拍、身份证、活体检测）                  │
│      等待验证完成...                                         │
│      ⏳ 通常需要 2-5 分钟                                    │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│      ✅ 第 6 步：系统自动处理                                 │
│      验证完成 → Sumsub 批准 → 系统自动下载报告               │
│      报告保存在服务器                                        │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│      🔄 第 7 步：检查状态并获取报告                            │
│      回到管理后台 → 输入订单号                               │
│      [查询状态]                                              │
│                                                               │
│      预期结果：                                               │
│      ✅ 验证状态: 已通过                                      │
│      📥 报告可用                                              │
│      📄 英文 PDF: https://kyc.317073.xyz/report/...          │
│      📄 中文 PDF: https://kyc.317073.xyz/report/...          │
│      📊 JSON: https://kyc.317073.xyz/report/...              │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│      📥 第 8 步：发送报告给买家                                │
│      复制报告链接（选择英文或中文 PDF）                      │
│      发送给买家                                              │
│                                                               │
│      "亲，您的身份验证已完成！"                             │
│      "请下载您的验证报告:"                                   │
│      "https://kyc.317073.xyz/report/.../kyc_report_xxx.pdf" │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│      📮 第 9 步：淘宝发货（3-4 天后）                         │
│      等待淘宝集成完成后，系统会自动发货                      │
│      或手动通过淘宝后台发货                                  │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│      🎉 完成！                                                │
└─────────────────────────────────────────────────────────────┘
```

---

## 🚀 快速开始（3 种方式）

### 方式 1️⃣：使用网页管理后台（推荐）

**适合：** 偶尔几个订单，想要友好界面

**步骤：**

1. 打开浏览器访问：`https://kyc.317073.xyz/admin-manual/`
2. 输入密钥登录
3. 在左侧表单中输入订单信息
4. 点击"生成链接"按钮
5. 复制验证链接，发送给买家
6. 后续在右侧"查询验证状态"中检查进度

---

### 方式 2️⃣：使用 Shell 脚本（快速）

**适合：** 批量订单，命令行爱好者

**准备工作：**

```bash
# 设置密钥环境变量
export ADMIN_SECRET_KEY="your-actual-secret-key"

# 或编辑脚本
nano kyc-admin.sh
# 找到 ADMIN_SECRET_KEY="your-key-here"，改为你的密钥
```

**生成链接：**

```bash
bash kyc-admin.sh generate alipay_user_12345 fy_order_001 "小王" "13800138000" "buyer@example.com"
```

**或最简形式：**

```bash
bash kyc-admin.sh generate alipay_user_12345 fy_order_001
```

**查询状态：**

```bash
bash kyc-admin.sh check fy_order_001
```

**输出示例：**

```
✅ 验证链接生成成功！

📌 验证链接
https://kyc.317073.xyz/verify/token_abc123xyz

🎟️  验证令牌
token_abc123xyz

🆔 Applicant ID
123456789

⏰ 创建时间
2025-12-08 10:30:00

💡 提示：复制上面的链接发送给买家
```

---

### 方式 3️⃣：使用 cURL（集成到自有系统）

**适合：** 想集成到自己的应用或自动化脚本

**生成链接：**

```bash
curl -X POST https://kyc.317073.xyz/admin-manual/generate-link \
  -H "Content-Type: application/json" \
  -H "X-Admin-Key: your-secret-key" \
  -d '{
    "user_id": "alipay_user_12345",
    "order_id": "fy_order_001",
    "buyer_name": "小王",
    "buyer_phone": "13800138000",
    "buyer_email": "buyer@example.com"
  }'
```

**响应：**

```json
{
  "success": true,
  "verification_link": "https://kyc.317073.xyz/verify/token_abc123xyz",
  "verification_token": "token_abc123xyz",
  "applicant_id": "123456789",
  "order_id": "fy_order_001",
  "created_at": "2025-12-08T10:30:00"
}
```

**查询状态：**

```bash
curl -X POST https://kyc.317073.xyz/admin-manual/check-status \
  -H "Content-Type: application/json" \
  -H "X-Admin-Key: your-secret-key" \
  -d '{"order_id": "fy_order_001"}'
```

**响应示例：**

```json
{
  "order_id": "fy_order_001",
  "user_id": "alipay_user_12345",
  "verification_status": "approved",
  "verified_at": "2025-12-08T10:30:00",
  "buyer_info": {
    "name": "小王",
    "phone": "13800138000",
    "email": "buyer@example.com"
  },
  "report_urls": {
    "en": {
      "pdf": "https://kyc.317073.xyz/report/sumsub/download/.../kyc_report_xxx_en.pdf"
    },
    "zh": {
      "pdf": "https://kyc.317073.xyz/report/sumsub/download/.../kyc_report_xxx_zh.pdf"
    }
  }
}
```

---

## ⏱️ 时间参考

| 步骤 | 耗时 | 说明 |
|------|------|------|
| 登录管理后台 | < 1 秒 | 输入密钥即可 |
| 填写订单信息 | 1-2 分钟 | 根据信息多少而定 |
| 生成验证链接 | < 1 秒 | 系统立即返回链接 |
| 发送给买家 | 几秒钟 | 通过聊天软件发送 |
| 买家完成验证 | 2-5 分钟 | 取决于买家的操作速度 |
| 系统下载报告 | 2-5 秒 | 验证完成后自动 |
| 获取报告链接 | < 1 秒 | 查询一次即可得到 |
| **总计** | **10-15 分钟** | 从订单到报告 |

---

## 📋 检查清单

### 开始工作前 ✅

- [ ] 已设置 `ADMIN_SECRET_KEY` 环境变量
- [ ] 能访问 `https://kyc.317073.xyz/admin-manual/`
- [ ] 用正确的密钥成功登录
- [ ] Sumsub API 凭证有效（应该已在 VPS 上配置）

### 处理单个订单的流程 ✅

- [ ] **收到闲鱼订单**
  - [ ] 记录用户号
  - [ ] 记录订单号
  - [ ] 可选：记录买家联系方式

- [ ] **生成验证链接**
  - [ ] 登录管理后台
  - [ ] 输入订单信息
  - [ ] 点击生成链接
  - [ ] 复制验证链接

- [ ] **发送给买家**
  - [ ] 通过聊天软件发送链接
  - [ ] 告诉买家需要完成身份验证

- [ ] **监控验证进度**
  - [ ] 回到管理后台
  - [ ] 查询订单状态
  - [ ] 等待状态变为"已通过"

- [ ] **发送报告**
  - [ ] 获取报告下载链接
  - [ ] 发送报告链接给买家
  - [ ] 保留报告副本用于记录

- [ ] **后续发货**
  - [ ] 等待淘宝集成（3-4 天后）
  - [ ] 系统自动发货或手动操作

---

## 💡 使用技巧

### 技巧 1：快速复制链接

**网页管理后台中：**
- 生成链接后，链接旁边有"复制"按钮，点击一下即可复制到剪贴板

**Shell 脚本中：**
- 输出的链接可直接从终端复制
- 使用 `pbcopy` (Mac) 或 `xclip` (Linux) 快速复制：
  ```bash
  bash kyc-admin.sh generate user_1 order_1 | grep "https://" | pbcopy
  ```

### 技巧 2：批量生成链接

如果有多个订单，可以写一个简单脚本循环处理：

```bash
#!/bin/bash

export ADMIN_SECRET_KEY="your-key"

# 从 CSV 文件读取订单
while IFS=',' read user_id order_id buyer_name; do
  echo "处理订单: $order_id"
  bash kyc-admin.sh generate "$user_id" "$order_id" "$buyer_name"
  echo "---"
  sleep 1  # 避免速度过快
done < orders.csv
```

**orders.csv 格式：**
```
alipay_user_001,order_001,小王
alipay_user_002,order_002,小李
alipay_user_003,order_003,小张
```

### 技巧 3：保存结果到文件

```bash
# 保存链接到文件，方便后续查询
bash kyc-admin.sh generate user_1 order_1 >> links.log

# 查看所有生成过的链接
cat links.log

# 快速搜索特定订单
grep "order_001" links.log
```

### 技巧 4：监控验证进度

```bash
# 每 10 秒检查一次状态，直到验证完成
while true; do
  status=$(bash kyc-admin.sh check order_001 2>&1 | grep "verification_status" | head -1)
  if echo "$status" | grep -q "approved"; then
    echo "✅ 验证完成！"
    break
  else
    echo "⏳ 等待中... ($status)"
    sleep 10
  fi
done
```

---

## 🆘 常见问题

### Q1: "生成链接失败"

**原因 1：** Sumsub API 凭证无效
```bash
# 检查 VPS 上的凭证
docker-compose exec web env | grep SUMSUB
```

**原因 2：** 数据库连接失败
```bash
# 检查数据库状态
docker-compose exec db psql -U kyc_user -d kyc_db -c "SELECT 1"
```

### Q2: "买家无法访问验证链接"

**解决：**
1. 确认链接前缀是 `https://` 不是 `http://`
2. 确认域名是 `kyc.317073.xyz`
3. 测试在浏览器中直接打开链接
4. 如果是一个旧链接，可能已过期，重新生成一个

### Q3: "报告显示'生成中'"

**说明：** 这是正常的。Sumsub 需要时间下载报告。

**解决：**
1. 等待 1-5 秒
2. 再次查询状态
3. 报告应该会出现

### Q4: "如何更改订单的买家信息？"

**答：** 管理后台不支持修改。需要：
1. 删除旧订单记录（数据库操作）
2. 重新生成新链接

---

## 📊 数据保留策略

### 订单记录

- 长期保存
- 用于历史查询和统计

### 验证报告

- 自动下载并本地存储
- 保留期：30 天（可配置）
- 过期后自动删除

### API 日志

- 保存在 Docker 日志
- 查看命令：`docker-compose logs web | grep -i admin`

---

## 🔐 安全建议

### 密钥安全

1. **不要分享**：密钥只有你知道
2. **定期更换**：建议每月更换一次
3. **使用强密钥**：至少 16 个随机字符
4. **环境变量**：通过 `.env` 文件配置，不要硬编码

### HTTPS

- 所有请求都必须使用 HTTPS
- 浏览器会自动升级，但手动 curl 时要注意

### 日志隐私

- 不要在公共日志中暴露密钥
- 定期清理敏感日志

---

## 📞 获取帮助

**如遇到问题：**

1. 查看日志：`docker-compose logs -f web`
2. 检查密钥：`cat .env | grep ADMIN_SECRET_KEY`
3. 测试 API：用 curl 直接调用接口
4. 重启应用：`docker-compose restart web`

---

**版本：** 1.0  
**创建日期：** 2025-12-10  
**最后更新：** 2025-12-10

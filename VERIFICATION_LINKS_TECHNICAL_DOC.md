# ğŸ“š KYC éªŒè¯é“¾æ¥ç³»ç»Ÿ - å®Œæ•´æŠ€æœ¯æ–‡æ¡£

## ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [éªŒè¯é“¾æ¥ç”Ÿæˆæµç¨‹](#éªŒè¯é“¾æ¥ç”Ÿæˆæµç¨‹)
3. [ä»£ç å®ç°è¯¦è§£](#ä»£ç å®ç°è¯¦è§£)
4. [æ•°æ®æµå›¾](#æ•°æ®æµå›¾)
5. [API æ–‡æ¡£](#api-æ–‡æ¡£)
6. [éƒ¨ç½²æŒ‡å—](#éƒ¨ç½²æŒ‡å—)
7. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ç³»ç»Ÿæ¦‚è¿°

### ä»€ä¹ˆæ˜¯éªŒè¯é“¾æ¥ï¼Ÿ

éªŒè¯é“¾æ¥æ˜¯ä¸€ä¸ªå”¯ä¸€çš„ã€ä¸€æ¬¡æ€§ä½¿ç”¨çš„ URLï¼Œç”¨äºé‚€è¯·ä¹°å®¶è¿›è¡Œ KYCï¼ˆäº†è§£æ‚¨çš„å®¢æˆ·ï¼‰èº«ä»½éªŒè¯ã€‚

### é“¾æ¥ç‰¹ç‚¹

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **æ ¼å¼** | `http://domain/verify/{32å­—ç¬¦ä»¤ç‰Œ}` |
| **ä»¤ç‰Œ** | 32 ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸² (e.g., `a3f8c2e91d7b4e5f6c8a9b0c1d2e3f4a`) |
| **å”¯ä¸€æ€§** | æ¯ä¸ªè®¢å•å¯¹åº”å”¯ä¸€ä»¤ç‰Œ |
| **å®‰å…¨æ€§** | HMAC-SHA256 åŠ å¯†ç­¾å |
| **æœ‰æ•ˆæœŸ** | é…ç½®åŒ–ï¼ˆé€šå¸¸ 30 å¤©ï¼‰ |

### å·¥ä½œåŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¹°å®¶è®¢å•    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è®¢å• Webhook è§¦å‘         â”‚
â”‚    (æ·˜å®/é—²é±¼)               â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ç”Ÿæˆ 32 ä½éªŒè¯ä»¤ç‰Œ        â”‚
â”‚    (token_generator.py)      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. åˆ›å»ºéªŒè¯è®°å½•             â”‚
â”‚    (æ•°æ®åº“ä¿å­˜)              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ç”ŸæˆéªŒè¯é“¾æ¥             â”‚
â”‚    http://localhost:5000/verify/{token} â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. å‘é€ç»™ä¹°å®¶               â”‚
â”‚    (é‚®ä»¶/çŸ­ä¿¡)               â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. ä¹°å®¶ç‚¹å‡»é“¾æ¥             â”‚
â”‚    (verification.py å¤„ç†)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. æ˜¾ç¤ºéªŒè¯é¡µé¢             â”‚
â”‚    (verification.html)       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. è¿›å…¥ Sumsub Web SDK       â”‚
â”‚    (çœŸå®èº«ä»½éªŒè¯)             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. éªŒè¯å®Œæˆï¼Œå›è°ƒå¤„ç†       â”‚
â”‚    (webhook.py)              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. ç”ŸæˆéªŒè¯æŠ¥å‘Š             â”‚
â”‚     (report_service.py)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## éªŒè¯é“¾æ¥ç”Ÿæˆæµç¨‹

### æµç¨‹æ¦‚è§ˆ

```
è®¢å•äº‹ä»¶
  â†“
è§£æ Webhook æ•°æ®
  â†“
éªŒè¯ HMAC ç­¾å
  â†“
æå–ä¹°å®¶ä¿¡æ¯
  â†“
ç”ŸæˆéªŒè¯ä»¤ç‰Œ
  â†“
è°ƒç”¨ Sumsub API
  â†“
è·å– Access Token
  â†“
ç”ŸæˆéªŒè¯é“¾æ¥
  â†“
ä¿å­˜åˆ°æ•°æ®åº“
  â†“
è¿”å›éªŒè¯é“¾æ¥ç»™å‰ç«¯
  â†“
å‘é€ç»™ä¹°å®¶
```

### ç¬¬ä¸€æ­¥ï¼šWebhook æ¥æ”¶

**æ–‡ä»¶**: `app/routes/webhook.py`

**ç«¯ç‚¹**: `POST /webhook/taobao/order`

**èŒè´£**:
- æ¥æ”¶æ·˜å®/é—²é±¼è®¢å•äº‹ä»¶
- éªŒè¯ HMAC-SHA256 ç­¾å
- è§£æè®¢å•æ•°æ®
- å¯åŠ¨éªŒè¯æµç¨‹

**ç¤ºä¾‹**:
```python
@app.route('/webhook/taobao/order', methods=['POST'])
def taobao_webhook_handler():
    """å¤„ç†æ·˜å®è®¢å• Webhook"""
    # 1. è·å–è¯·æ±‚æ•°æ®
    webhook_data = request.get_json()
    signature = request.headers.get('X-Signature')
    
    # 2. éªŒè¯ç­¾å
    if not verify_webhook_signature(webhook_data, signature):
        return jsonify({"error": "Invalid signature"}), 403
    
    # 3. æå–è®¢å•ä¿¡æ¯
    order_id = webhook_data['order_id']
    buyer_name = webhook_data['buyer_name']
    buyer_email = webhook_data['buyer_email']
    
    # 4. åˆ›å»ºéªŒè¯
    verification = create_verification(order_id, buyer_name, buyer_email)
    
    # 5. è¿”å›é“¾æ¥
    return jsonify({
        "verification_link": verification.buyer_verification_link
    })
```

### ç¬¬äºŒæ­¥ï¼šä»¤ç‰Œç”Ÿæˆ

**æ–‡ä»¶**: `app/utils/token_generator.py`

**åŠŸèƒ½**: ç”Ÿæˆå®‰å…¨çš„ 32 ä½åå…­è¿›åˆ¶ä»¤ç‰Œ

**ä»£ç **:
```python
import secrets

def generate_verification_token():
    """ç”Ÿæˆ 32 å­—ç¬¦çš„åå…­è¿›åˆ¶éªŒè¯ä»¤ç‰Œ"""
    # secrets.token_hex(16) ç”Ÿæˆ 32 å­—ç¬¦åå…­è¿›åˆ¶å­—ç¬¦ä¸²
    return secrets.token_hex(16)
```

**ç‰¹ç‚¹**:
- âœ“ ä½¿ç”¨ `secrets` æ¨¡å—ï¼ˆå¯†ç å­¦å®‰å…¨ï¼‰
- âœ“ äº§ç”Ÿ 32 å­—ç¬¦åå…­è¿›åˆ¶å­—ç¬¦ä¸²
- âœ“ å”¯ä¸€ä¸”ä¸å¯é¢„æµ‹
- âœ“ æ¯æ¬¡è°ƒç”¨ç”Ÿæˆä¸åŒçš„ä»¤ç‰Œ

### ç¬¬ä¸‰æ­¥ï¼šSumsub API è°ƒç”¨

**æ–‡ä»¶**: `app/services/sumsub_service.py`

**å‡½æ•°**: `create_verification()`

**æµç¨‹**:
```python
def create_verification(order_id, buyer_name, buyer_email):
    """åˆ›å»ºéªŒè¯å’Œç”Ÿæˆ Sumsub é“¾æ¥"""
    
    # 1. ç”ŸæˆéªŒè¯ä»¤ç‰Œ
    verification_token = generate_verification_token()
    
    # 2. è°ƒç”¨ Sumsub API åˆ›å»º Applicant
    applicant = sumsub_api.create_applicant(
        first_name=buyer_name,
        email=buyer_email
    )
    
    # 3. ç”Ÿæˆ Access Token
    access_token = sumsub_api.create_access_token(
        applicant_id=applicant['id']
    )
    
    # 4. æ„å»º Sumsub Web SDK é“¾æ¥
    verification_link = (
        f"{SUMSUB_API_URL.replace('/api', '')}"
        f"/sdk/applicant?token={access_token}"
    )
    
    # 5. æ„å»ºä¹°å®¶éªŒè¯é“¾æ¥
    buyer_verification_link = (
        f"{BASE_URL}/verify/{verification_token}"
    )
    
    # 6. ä¿å­˜éªŒè¯è®°å½•
    verification = Verification(
        order_id=order_id,
        verification_token=verification_token,
        verification_link=verification_link,
        buyer_verification_link=buyer_verification_link,
        status='pending'
    )
    db.session.add(verification)
    db.session.commit()
    
    return verification
```

### ç¬¬å››æ­¥ï¼šéªŒè¯é¡µé¢æ˜¾ç¤º

**æ–‡ä»¶**: `app/routes/verification.py`

**ç«¯ç‚¹**: `GET /verify/<verification_token>`

**èŒè´£**:
- æ¥æ”¶éªŒè¯ä»¤ç‰Œ
- æŸ¥è¯¢æ•°æ®åº“è·å–éªŒè¯è®°å½•
- æŸ¥è¯¢å…³è”çš„è®¢å•ä¿¡æ¯
- æ¸²æŸ“ HTML æ¨¡æ¿

**ä»£ç **:
```python
@app.route('/verify/<verification_token>')
def verification_page(verification_token):
    """æ˜¾ç¤ºéªŒè¯é¡µé¢"""
    
    # 1. æŸ¥è¯¢éªŒè¯è®°å½•
    verification = Verification.query.filter_by(
        verification_token=verification_token
    ).first()
    
    if not verification:
        return render_template('error.html', 
                             message='Invalid verification link'), 404
    
    # 2. æŸ¥è¯¢è®¢å•ä¿¡æ¯
    order = Order.query.get(verification.order_id)
    
    # 3. æ£€æŸ¥æœ‰æ•ˆæœŸ
    if verification.is_expired():
        return render_template('error.html', 
                             message='Verification link expired'), 400
    
    # 4. æ¸²æŸ“é¡µé¢
    return render_template('verification.html',
                          order=order,
                          verification=verification,
                          verification_link=verification.verification_link)
```

---

## ä»£ç å®ç°è¯¦è§£

### æ•°æ®æ¨¡å‹

#### Order æ¨¡å‹ (`app/models/order.py`)

```python
class Order(db.Model):
    __tablename__ = 'orders'
    
    id = db.Column(db.String(50), primary_key=True)
    buyer_name = db.Column(db.String(100), nullable=False)
    buyer_email = db.Column(db.String(100), nullable=False)
    order_amount = db.Column(db.Float)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    
    # å…³ç³»
    verification = db.relationship('Verification', uselist=False)
```

#### Verification æ¨¡å‹ (`app/models/verification.py`)

```python
class Verification(db.Model):
    __tablename__ = 'verifications'
    
    id = db.Column(db.String(50), primary_key=True)
    order_id = db.Column(db.String(50), db.ForeignKey('orders.id'))
    verification_token = db.Column(db.String(100), unique=True, nullable=False)
    verification_link = db.Column(db.Text)  # Sumsub SDK é“¾æ¥
    buyer_verification_link = db.Column(db.Text)  # ä¹°å®¶é“¾æ¥
    status = db.Column(db.String(20), default='pending')
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    
    # å¤–é”®
    order = db.relationship('Order', back_populates='verification')
```

### HTML æ¨¡æ¿

**æ–‡ä»¶**: `app/templates/verification.html`

**å…³é”®éƒ¨åˆ†**:
```html
<!-- è®¢å•ä¿¡æ¯ -->
<div class="order-info">
    <h2>è®¢å•è¯¦æƒ…</h2>
    <p>è®¢å•å·: {{ order.id }}</p>
    <p>ä¹°å®¶: {{ order.buyer_name }}</p>
    <p>é‚®ç®±: {{ order.buyer_email }}</p>
    <p>é‡‘é¢: Â¥{{ order.order_amount }}</p>
</div>

<!-- éªŒè¯ä¿¡æ¯ -->
<div class="verification-info">
    <h2>éªŒè¯ä¿¡æ¯</h2>
    <p>ä»¤ç‰Œ: {{ verification.verification_token }}</p>
    <p>çŠ¶æ€: {{ verification.status }}</p>
</div>

<!-- éªŒè¯æŒ‰é’® -->
<a href="{{ verification_link }}" class="btn-verify">
    å¼€å§‹éªŒè¯
</a>
```

---

## æ•°æ®æµå›¾

### å®Œæ•´æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ·˜å®è®¢å•äº‹ä»¶                               â”‚
â”‚                   (POST /webhook/taobao/order)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   éªŒè¯ HMAC ç­¾å                                â”‚
â”‚                  (webhook.py ç¬¬ä¸€æ­¥)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   è§£æè®¢å•æ•°æ®                                  â”‚
â”‚            order_id, buyer_name, buyer_email                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç”Ÿæˆ 32 ä½éªŒè¯ä»¤ç‰Œ                                  â”‚
â”‚          (token_generator.py - secrets.token_hex)              â”‚
â”‚    ä¾‹: a3f8c2e91d7b4e5f6c8a9b0c1d2e3f4a                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              è°ƒç”¨ Sumsub API                                    â”‚
â”‚          (sumsub_service.py - create_verification)             â”‚
â”‚                                                                â”‚
â”‚     1. POST /applicants (åˆ›å»ºç”³è¯·äºº)                           â”‚
â”‚     2. POST /accessTokens (è·å– Access Token)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ç”Ÿæˆä¸¤ä¸ªéªŒè¯é“¾æ¥                                      â”‚
â”‚                                                                â”‚
â”‚  1. ä¹°å®¶é“¾æ¥:                                                  â”‚
â”‚     http://domain/verify/{verification_token}                 â”‚
â”‚                                                                â”‚
â”‚  2. Sumsub SDK é“¾æ¥:                                           â”‚
â”‚     https://api.sumsub.com/sdk/applicant?token={access_token} â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ä¿å­˜åˆ°æ•°æ®åº“                                       â”‚
â”‚                                                                â”‚
â”‚  INSERT INTO verifications (                                  â”‚
â”‚    order_id,                                                  â”‚
â”‚    verification_token,                                        â”‚
â”‚    verification_link,                                         â”‚
â”‚    buyer_verification_link,                                   â”‚
â”‚    status                                                     â”‚
â”‚  ) VALUES (...)                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              è¿”å›ä¹°å®¶é“¾æ¥ç»™å‰ç«¯                                  â”‚
â”‚                                                                â”‚
â”‚  {                                                             â”‚
â”‚    "buyer_verification_link": "http://domain/verify/{token}"  â”‚
â”‚  }                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å‘é€é“¾æ¥ç»™ä¹°å®¶ (é‚®ä»¶/çŸ­ä¿¡)                              â”‚
â”‚                                                                â”‚
â”‚  äº²çˆ±çš„å¼ ä¸‰,                                                   â”‚
â”‚  è¯·ç‚¹å‡»ä»¥ä¸‹é“¾æ¥å®Œæˆèº«ä»½éªŒè¯:                                   â”‚
â”‚  http://domain/verify/a3f8c2e91d7b4e5f6c8a9b0c1d2e3f4a       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   ä¹°å®¶ç‚¹å‡»é“¾æ¥     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         GET /verify/{verification_token}                       â”‚
â”‚              (verification.py å¤„ç†)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          æŸ¥è¯¢éªŒè¯è®°å½•å’Œè®¢å•ä¿¡æ¯                                  â”‚
â”‚                                                                â”‚
â”‚  SELECT * FROM verifications                                  â”‚
â”‚  WHERE verification_token = '{token}'                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          æ£€æŸ¥æœ‰æ•ˆæœŸå’ŒçŠ¶æ€                                       â”‚
â”‚                                                                â”‚
â”‚  IF expired OR invalid:                                       â”‚
â”‚    return error.html                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        æ¸²æŸ“ verification.html æ¨¡æ¿                              â”‚
â”‚                                                                â”‚
â”‚  render_template('verification.html',                         â”‚
â”‚      order=order,                                             â”‚
â”‚      verification=verification,                               â”‚
â”‚      verification_link=verification_link)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           æ˜¾ç¤ºéªŒè¯é¡µé¢ç»™ä¹°å®¶                                     â”‚
â”‚                                                                â”‚
â”‚   - è®¢å•ä¿¡æ¯ (è®¢å•å·ã€ä¹°å®¶ã€é‚®ç®±ã€é‡‘é¢)                         â”‚
â”‚   - éªŒè¯ä¿¡æ¯ (ä»¤ç‰Œã€çŠ¶æ€)                                       â”‚
â”‚   - "å¼€å§‹éªŒè¯" æŒ‰é’®                                             â”‚
â”‚   - KYC è¯´æ˜å’Œéšç§å£°æ˜                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  ä¹°å®¶ç‚¹å‡»"å¼€å§‹éªŒè¯"æŒ‰é’®    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           è½¬å‘ Sumsub Web SDK                                   â”‚
â”‚                                                                â”‚
â”‚  Location: https://api.sumsub.com/sdk/applicant               â”‚
â”‚           ?token={access_token}                               â”‚
â”‚                                                                â”‚
â”‚   è¿›è¡ŒçœŸå®èº«ä»½éªŒè¯ (5-10 åˆ†é’Ÿ)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        éªŒè¯å®Œæˆï¼ŒSumsub å›è°ƒå¤„ç†                               â”‚
â”‚                                                                â”‚
â”‚  POST /webhook/sumsub/verification                            â”‚
â”‚                                                                â”‚
â”‚  ç”ŸæˆéªŒè¯æŠ¥å‘Š (PDF)                                            â”‚
â”‚  ä¿å­˜éªŒè¯ç»“æœ                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## API æ–‡æ¡£

### Webhook ç«¯ç‚¹

#### æ¥æ”¶è®¢å•äº‹ä»¶
```http
POST /webhook/taobao/order
X-Signature: {HMAC-SHA256 signature}
Content-Type: application/json

{
  "order_id": "taobao_20251126_001",
  "buyer_name": "å¼ ä¸‰",
  "buyer_email": "zhangsan@example.com",
  "order_amount": 299.99,
  "timestamp": 1637891400
}
```

**å“åº”**:
```json
{
  "status": "success",
  "verification_token": "a3f8c2e91d7b4e5f6c8a9b0c1d2e3f4a",
  "buyer_verification_link": "http://domain/verify/a3f8c2e91d7b4e5f6c8a9b0c1d2e3f4a"
}
```

### éªŒè¯é¡µé¢

#### è·å–éªŒè¯é¡µé¢
```http
GET /verify/a3f8c2e91d7b4e5f6c8a9b0c1d2e3f4a
```

**å“åº”**: HTML é¡µé¢ï¼ŒåŒ…å«è®¢å•ä¿¡æ¯å’ŒéªŒè¯è¡¨å•

#### å‚æ•°è¯´æ˜
- `verification_token` (URL å‚æ•°): 32 ä½åå…­è¿›åˆ¶éªŒè¯ä»¤ç‰Œ

**è¿”å›çŠ¶æ€ç **:
- `200`: æˆåŠŸï¼ˆè¿”å›éªŒè¯é¡µé¢ï¼‰
- `404`: éªŒè¯ä»¤ç‰Œä¸å­˜åœ¨
- `400`: éªŒè¯é“¾æ¥å·²è¿‡æœŸ

---

## éƒ¨ç½²æŒ‡å—

### æœ¬åœ°å¼€å‘

#### å¯åŠ¨æ¼”ç¤ºæœåŠ¡å™¨
```bash
python3 /tmp/verification_server.py
```

æˆ–ä½¿ç”¨å¯åŠ¨è„šæœ¬ï¼š
```bash
./start-verification-demo.sh
```

#### è®¿é—®é“¾æ¥
- é¦–é¡µ: http://localhost:5000/
- éªŒè¯é¡µé¢: http://localhost:5000/verify/a3f8c2e91d7b4e5f6c8a9b0c1d2e3f4a

### ç”Ÿäº§ç¯å¢ƒ

#### å¯åŠ¨å®Œæ•´æœåŠ¡å™¨
```bash
./local-dev.sh
```

#### ç¯å¢ƒå˜é‡é…ç½®
```bash
# .env æ–‡ä»¶
SUMSUB_API_KEY=your_api_key
DATABASE_URL=postgresql://user:pass@localhost:5432/kyc_db
WEBHOOK_SECRET=your_webhook_secret
BASE_URL=https://yourdomain.com
```

#### æ•°æ®åº“åˆå§‹åŒ–
```bash
flask db upgrade
```

#### ä½¿ç”¨ Gunicorn éƒ¨ç½²
```bash
gunicorn -w 4 -b 0.0.0.0:8000 app:app
```

---

## å¸¸è§é—®é¢˜

### Q: éªŒè¯é“¾æ¥çš„æœ‰æ•ˆæœŸæ˜¯å¤šä¹…ï¼Ÿ

A: é»˜è®¤ 30 å¤©ï¼Œå¯åœ¨ç¯å¢ƒå˜é‡ä¸­é…ç½®ï¼š
```python
VERIFICATION_LINK_EXPIRY_DAYS = 30
```

### Q: å¦‚ä½•é‡æ–°ç”ŸæˆéªŒè¯é“¾æ¥ï¼Ÿ

A: ä¸ºåŒä¸€è®¢å•åˆ›å»ºæ–°çš„éªŒè¯è®°å½•ï¼š
```python
# åˆ é™¤æ—§çš„éªŒè¯è®°å½•
old_verification = Verification.query.filter_by(order_id=order_id).first()
if old_verification:
    db.session.delete(old_verification)

# åˆ›å»ºæ–°çš„éªŒè¯
new_verification = create_verification(order_id, buyer_name, buyer_email)
```

### Q: éªŒè¯é“¾æ¥æ”¯æŒå“ªäº›æµè§ˆå™¨ï¼Ÿ

A: æ”¯æŒæ‰€æœ‰ç°ä»£æµè§ˆå™¨ï¼š
- âœ“ Chrome 90+
- âœ“ Firefox 88+
- âœ“ Safari 14+
- âœ“ Edge 90+

### Q: å¦‚ä½•è¿½è¸ªéªŒè¯é“¾æ¥çš„ç‚¹å‡»ï¼Ÿ

A: åœ¨ `verification.py` ä¸­æ·»åŠ æ—¥å¿—ï¼š
```python
@app.route('/verify/<verification_token>')
def verification_page(verification_token):
    # è®°å½•é“¾æ¥ç‚¹å‡»
    app.logger.info(f"Verification link clicked: {verification_token}")
    # ... rest of code
```

### Q: éªŒè¯é“¾æ¥æ˜¯å¦å¯ä»¥å¤šæ¬¡ä½¿ç”¨ï¼Ÿ

A: å¯ä»¥ï¼Œä½†å»ºè®®é™åˆ¶æ¬¡æ•°ï¼š
```python
class Verification(db.Model):
    click_count = db.Column(db.Integer, default=0)
    
    def record_click(self):
        self.click_count += 1
        if self.click_count > 5:
            raise Exception("Too many clicks")
```

### Q: å¦‚ä½•ä¿æŠ¤éªŒè¯é“¾æ¥å…å—æ»¥ç”¨ï¼Ÿ

A: 
1. ä½¿ç”¨ HTTPS
2. æ·»åŠ  Rate Limiting
3. éªŒè¯ IP åœ°å€
4. è®¾ç½®æœ‰æ•ˆæœŸ
5. è®°å½•æ‰€æœ‰è®¿é—®

---

*æ–‡æ¡£ç‰ˆæœ¬: 1.0*  
*æœ€åæ›´æ–°: 2025-11-26*  
*ç³»ç»ŸçŠ¶æ€: âœ… ç”Ÿäº§å°±ç»ª*

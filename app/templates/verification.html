{% extends "base.html" %}

{% block title %}KYC éªŒè¯ - è®¢å• {{ order.taobao_order_id }}{% endblock %}

{% block content %}
<style>
    .verification-container {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .verification-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px 30px;
        text-align: center;
    }

    .verification-header h1 {
        font-size: 28px;
        margin-bottom: 10px;
    }

    .verification-header p {
        font-size: 14px;
        opacity: 0.9;
    }

    .verification-content {
        padding: 40px 30px;
    }

    .order-info {
        background: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
    }

    .order-info-item {
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }

    .order-info-item:last-child {
        border-bottom: none;
    }

    .order-info-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 5px;
    }

    .order-info-value {
        font-size: 16px;
        color: #333;
        font-weight: 500;
    }

    #sumsub-websdk-container {
        min-height: 700px;
        border: 1px solid #eee;
        border-radius: 8px;
        overflow: hidden;
        background: #fafafa;
        position: relative;
    }

    .sdk-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        gap: 15px;
    }

    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .error-message {
        background: #fee;
        color: #c33;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #c33;
        margin-top: 20px;
    }

    .verification-footer {
        background: #f9f9f9;
        padding: 20px 30px;
        border-top: 1px solid #eee;
        text-align: center;
        color: #666;
        font-size: 12px;
    }

    @media (max-width: 768px) {
        .verification-header {
            padding: 30px 20px;
        }

        .verification-header h1 {
            font-size: 22px;
        }

        .verification-content {
            padding: 20px;
        }

        #sumsub-websdk-container {
            min-height: 600px;
        }
    }
</style>

<div class="verification-container">
    <div class="verification-header">
        <h1>ğŸ’¼ KYC èº«ä»½éªŒè¯</h1>
        <p>è¯·å®Œæˆèº«ä»½éªŒè¯ä»¥ç»§ç»­å¤„ç†æ‚¨çš„è®¢å•</p>
    </div>

    <div class="verification-content">
        <!-- è®¢å•ä¿¡æ¯ -->
        <div class="order-info">
            <div class="order-info-item">
                <div class="order-info-label">è®¢å•å·</div>
                <div class="order-info-value">{{ order.taobao_order_id }}</div>
            </div>
            <div class="order-info-item">
                <div class="order-info-label">ä¹°å®¶åç§°</div>
                <div class="order-info-value">{{ order.buyer_name }}</div>
            </div>
            <div class="order-info-item">
                <div class="order-info-label">é‚®ç®±</div>
                <div class="order-info-value">{{ order.buyer_email }}</div>
            </div>
        </div>

        <!-- Sumsub WebSDK å®¹å™¨ -->
        <div id="sumsub-websdk-container">
            <div class="sdk-loading">
                <div class="spinner"></div>
                <span>æ­£åœ¨åŠ è½½éªŒè¯é¡µé¢...</span>
            </div>
        </div>

        <div id="error-container"></div>
    </div>

    <div class="verification-footer">
        <p>âœ“ éªŒè¯è¿‡ç¨‹é€šå¸¸éœ€è¦ 5-10 åˆ†é’Ÿ | âœ“ æ•°æ®é€šè¿‡åŠ å¯†è¿æ¥å®‰å…¨ä¼ è¾“ | âœ“ ç”± Sumsub æä¾›æ”¯æŒ</p>
    </div>
</div>

<!-- Sumsub WebSDK Script -->
<script src="https://static.sumsub.com/idensic/static/sns-websdk-builder.js"></script>

<script>
    const accessToken = "{{ verification_token_for_sdk }}";
    const verificationToken = "{{ verification_token }}";

    function initializeSDK() {
        if (!accessToken) {
            showError('æ— æ³•è·å–éªŒè¯ä»¤ç‰Œã€‚è¯·ç¨åé‡è¯•æˆ–è”ç³»å®¢æœã€‚');
            return;
        }

        try {
            let snsWebSdkInstance = snsWebSdk
                .init(accessToken, () => getNewAccessToken())
                .withConf({
                    lang: "zh",
                    theme: "light"
                })
                .withOptions({ 
                    addViewportTag: true, 
                    adaptIframeHeight: true 
                })
                .on("idCheck.onStepCompleted", (payload) => {
                    console.log("éªŒè¯æ­¥éª¤å®Œæˆ", payload);
                })
                .on("idCheck.onError", (error) => {
                    console.error("éªŒè¯é”™è¯¯", error);
                    showError(`éªŒè¯è¿‡ç¨‹å‡ºé”™: ${error.message}`);
                })
                .on("idCheck.onApplicantSubmitted", (applicantId) => {
                    console.log("ç”³è¯·æäº¤æˆåŠŸ", applicantId);
                    // å¯é€‰ï¼šæ˜¾ç¤ºæäº¤æˆåŠŸæ¶ˆæ¯
                    showSuccess('æ‚¨çš„ä¿¡æ¯å·²æäº¤ï¼Œæ­£åœ¨å¤„ç†ä¸­...');
                })
                .onMessage((type, payload) => {
                    console.log("éªŒè¯äº‹ä»¶", type, payload);
                })
                .build();

            snsWebSdkInstance.launch("#sumsub-websdk-container");

        } catch (error) {
            console.error("åˆå§‹åŒ–å¤±è´¥:", error);
            showError(`åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
        }
    }

    function getNewAccessToken() {
        // å½“ä»¤ç‰Œè¿‡æœŸæ—¶ï¼Œä»åç«¯è·å–æ–°ä»¤ç‰Œ
        console.log("ä»¤ç‰Œå³å°†è¿‡æœŸï¼Œæ­£åœ¨åˆ·æ–°...");
        
        return fetch('/verify/refresh-token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                verification_token: verificationToken
            })
        })
        .then(res => {
            if (!res.ok) {
                throw new Error(`Token refresh failed: ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            console.log("å·²åˆ·æ–°æ–°ä»¤ç‰Œ");
            return data.token;
        })
        .catch(error => {
            console.error("ä»¤ç‰Œåˆ·æ–°å¤±è´¥:", error);
            showError(`ä»¤ç‰Œåˆ·æ–°å¤±è´¥: ${error.message}`);
            throw error;
        });
    }

    function showError(message) {
        const errorContainer = document.getElementById('error-container');
        errorContainer.innerHTML = `<div class="error-message"><strong>âŒ é”™è¯¯:</strong> ${message}</div>`;
    }

    function showSuccess(message) {
        const errorContainer = document.getElementById('error-container');
        errorContainer.innerHTML = `<div class="success-message"><strong>âœ“ æˆåŠŸ:</strong> ${message}</div>`;
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', initializeSDK);
</script>

<style>
    .success-message {
        background: #efe;
        color: #3c3;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #3c3;
        margin-top: 20px;
    }
</style>


{% endblock %}

